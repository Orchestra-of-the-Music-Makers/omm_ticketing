<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <script src="//mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script src="/booklet.js"></script>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <pre id="elm"></pre>
    <script type="text/javascript">
      if('serviceWorker' in navigator) {
        navigator.serviceWorker
                .register('/sw.js')
                .then(function() { console.log("Service Worker Registered"); });
      }

      window.addEventListener('online', () => console.log('Became online'));
      window.addEventListener('offline', () => console.log('Became offline'));

      var urlParams = new URLSearchParams(window.location.search);

      // CONCERT DATA, change here for different pdfs
      var url = "assets/Mahler_Mobile.pdf";
      var pdfjsLib = window['pdfjs-dist/build/pdf'];

      // The workerSrc property shall be specified.
      pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';
      pdfjsLib.getDocument(url).promise.then(pdf => {
        let pageNum = 1;
        var flags = {};
        var app = Elm.Booklet.init({
          node: document.getElementById("elm"),
          flags: flags,
        });

        function scaleCanvas(canvas, context, width, height) {
          // assume the device pixel ratio is 1 if the browser doesn't specify it
          const devicePixelRatio = window.devicePixelRatio || 1;

          // determine the 'backing store ratio' of the canvas context
          const backingStoreRatio = (
            context.webkitBackingStorePixelRatio ||
            context.mozBackingStorePixelRatio ||
            context.msBackingStorePixelRatio ||
            context.oBackingStorePixelRatio ||
            context.backingStorePixelRatio || 1
          );

          // determine the actual ratio we want to draw at
          const ratio = devicePixelRatio / backingStoreRatio;

          if (devicePixelRatio !== backingStoreRatio) {
            // set the 'real' canvas size to the higher width/height
            canvas.width = width * ratio;
            canvas.height = height * ratio;

            // ...then scale it back down with CSS
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
          }
          else {
            // this is a normal 1:1 device; just scale it simply
            canvas.width = width;
            canvas.height = height;
            canvas.style.width = '';
            canvas.style.height = '';
          }

          // scale the drawing context so everything will work at the higher ratio
          context.scale(ratio, ratio);
        }

        function renderPage(num) {
          pdf.getPage(num).then(page => {

            // calculate viewport
            var desiredWidth = window.innerWidth;
            var viewport = page.getViewport({ scale: 1 });
            var scale = desiredWidth / viewport.width;
            var scaledViewport = page.getViewport({ scale: scale });

            // set canvas
            var canvasId = 'pdf-viewer-' + num;
            var canvas = document.createElement('canvas');
            canvas.setAttribute("id", canvasId)
            document.getElementById('pdf-viewer').appendChild(canvas);
            var context = canvas.getContext('2d');
            scaleCanvas(canvas, context, window.innerWidth, window.innerWidth*1.76);

            var renderContext = {
              canvasContext: context,
              viewport: scaledViewport
            };
            page.render(renderContext);
          });
        }

        for (var i = 1; i <= pdf.numPages; i++) {
            renderPage(i);
        }
      });
    </script>
  </body>
</html>
